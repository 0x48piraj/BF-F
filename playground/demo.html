<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BF-F SDK Demo</title>

  <!-- Fake ad script bait -->
  <script async
    src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
    onerror="window.adBlockerEnabled = true;">
  </script>

  <!-- Strategy graph -->
  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link
    href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: monospace;
      background: #0e0e0e;
      color: #ddd;
      padding: 20px;
    }

    h1 { margin-bottom: 10px; }

    .ok { color: #00ff9c; }
    .warn { color: #ffd166; }
    .bad { color: #ff5f5f; }

    .panel {
      margin-top: 16px;
      padding: 12px;
      border: 1px dashed #333;
    }

    .row {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    label {
      display: block;
      margin-bottom: 6px;
    }

    input[type="range"] {
      width: 160px;
    }

    pre {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed #333;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h1>BF-F SDK Demo</h1>

<!-- Detection selection -->
<div class="panel">
  <strong>Detection</strong>
  <label>
    Type:
    <select id="type">
      <option value="bot" selected>Bot</option>
      <option value="adblock">Adblock</option>
    </select>
  </label>
</div>

<!-- Policy controls -->
<div class="panel">
  <strong>Policy</strong>

  <div class="row">
    <div>
      <label>
        Preset:
        <select id="preset">
          <option value="conservative">Conservative</option>
          <option value="balanced" selected>Balanced</option>
          <option value="aggressive">Aggressive</option>
        </select>
      </label>
    </div>

    <div>
      <label>
        Base risk threshold:
        <input
          id="threshold"
          type="range"
          min="0"
          max="1"
          step="0.01"
          value="0.6"
        />
        <span id="thresholdValue">0.60</span>
      </label>
    </div>
  </div>
</div>

<!-- Derived thresholds -->
<div class="panel">
  <strong>Derived thresholds</strong><br />
  Block: <span id="blockT">-</span><br />
  Challenge: <span id="challengeT">-</span><br />
  Monitor: <span id="monitorT">-</span>
</div>

<!-- Results -->
<pre id="output">Loading…</pre>

<!-- Strategy graph -->
<div class="panel">
  <strong>Strategy Execution Graph</strong>
  <div style="margin-top:6px; font-size:12px; color:#999">
    <span style="color:#ff5f5f">■</span> Primary signal contributor
  </div>
  <div id="graph" style="height:300px; margin-top:10px;"></div>
</div>

<script src="../dist/browser.global.js"></script>
<script>
(async function () {
  const engine = BFF.create()

  const typeSelect = document.getElementById('type')
  const presetSelect = document.getElementById('preset')
  const thresholdInput = document.getElementById('threshold')
  const thresholdValue = document.getElementById('thresholdValue')
  const output = document.getElementById('output')

  const blockT = document.getElementById('blockT')
  const challengeT = document.getElementById('challengeT')
  const monitorT = document.getElementById('monitorT')

  let network = null
  let result = null

  // Policy profiles
  const POLICY_PROFILES = {
    conservative: { monitor: 0.8 },
    balanced: { block: 1.0, challenge: 0.6, monitor: 0.3 },
    aggressive: { block: 0.7, challenge: 0.4 }
  }

  function buildPolicy(base, preset) {
    const policy = new BFF.PolicyEngine()
    const profile = POLICY_PROFILES[preset]

    for (const action in profile) {
      policy.use(
        BFF.confidenceRule(
          base * profile[action],
          action
        )
      )
    }

    return policy
  }

  function renderPolicyThresholds(base, preset) {
    const profile = POLICY_PROFILES[preset]

    blockT.textContent =
      profile.block != null ? (base * profile.block).toFixed(2) : '-'

    challengeT.textContent =
      profile.challenge != null ? (base * profile.challenge).toFixed(2) : '-'

    monitorT.textContent =
      profile.monitor != null ? (base * profile.monitor).toFixed(2) : '-'
  }

  // Strategy graph
  const STRATEGY_META = {
    'bot:webdriver': {},
    'bot:globals': {},
    'adblock:script': {},
    'adblock:dom': { after: ['adblock:script'] }
  }

  function getContribution(s) {
    return (s.weight ?? 1) * (s.confidence ?? 0)
  }

  function getTopContributors(signals, n = 2) {
    return signals
      .map(s => ({
        id: s.strategy,
        value: getContribution(s)
      }))
      .sort((a, b) => b.value - a.value)
      .slice(0, n)
      .filter(x => x.value > 0)
      .map(x => x.id)
  }

  function renderGraph(signals) {
    const nodes = []
    const edges = []

    const top = getTopContributors(signals)

    signals.forEach((s, i) => {
      const contribution = getContribution(s)
      const enabled = contribution > 0
      const isTop = top.includes(s.strategy)

      const borderColor = isTop
        ? '#ff5f5f'   // high contributor
        : '#555'      // neutral

      let bg = '#222'
      if (contribution > 1.2) bg = '#3a1f1f'      // high
      else if (contribution > 0.5) bg = '#3a331f' // mid

      nodes.push({
        id: s.strategy,
        label: `${i + 1}. ${s.strategy}`,
        shape: 'box',
        opacity: enabled ? 1 : 0.25,
        color: {
          background: bg,
          border: borderColor,
          highlight: {
            background: bg,
            border: borderColor
          },
          hover: {
            background: bg,
            border: borderColor
          }
        },
        font: {
          color: enabled ? '#ddd' : '#666'
        }
      })

      const meta = STRATEGY_META[s.strategy]
      const deps = meta?.after || meta?.dependsOn || []

      deps.forEach(dep => {
        edges.push({
          from: dep,
          to: s.strategy,
          arrows: 'to',
          color: enabled ? '#888' : '#444',
          dashes: true,
          animation: {
            enabled: contribution > 0.5,
            duration: 800,
            easingFunction: 'easeInOutQuad'
          }
        })
      })
    })

    const data = { nodes, edges }

    const options = {
      layout: {
        hierarchical: {
          enabled: true,
          direction: 'UD',
          sortMethod: 'directed'
        }
      },
      physics: false,
      interaction: {
        dragNodes: false,
        hover: true,
        selectable: false
      }
    }

    if (network) {
      network.setData(data)
    } else {
      network = new vis.Network(
        document.getElementById('graph'),
        data,
        options
      )
    }
  }

  // Detection / render loop
  async function runDetection() {
    result = await engine.detect(typeSelect.value)
    render()
  }

  function render() {
    if (!result) return

    const threshold = Number(thresholdInput.value)
    const preset = presetSelect.value

    thresholdValue.textContent = threshold.toFixed(2)
    renderPolicyThresholds(threshold, preset)

    const policy = buildPolicy(threshold, preset)

    let suspicion = 0
    for (const s of result.signals) {
      suspicion += getContribution(s)
    }

    const confidence = Math.min(1, suspicion)
    const decision = policy.evaluate({
      ...result,
      suspicion,
      confidence
    })

    let cls = 'ok'
    if (decision.action === 'challenge') cls = 'warn'
    if (decision.action === 'block') cls = 'bad'

    let text = ''
    text += `${typeSelect.value.toUpperCase()} DETECTION\n`
    text += `Suspicion: ${suspicion.toFixed(2)}\n`
    text += `Confidence: ${confidence.toFixed(2)}\n`
    text += `Decision: ${decision.action.toUpperCase()}\n\n`
    text += 'Signals:\n'

    for (const s of result.signals) {
      const c = getContribution(s)
      text += `- ${s.strategy}\n`
      text += `  confidence: ${s.confidence ?? 0}\n`
      text += `  weight: ${s.weight ?? 1}\n`
      text += `  contribution: ${c.toFixed(2)}\n\n`
    }

    output.textContent = text
    output.className = cls

    renderGraph(result.signals)
  }

  thresholdInput.addEventListener('input', render)
  presetSelect.addEventListener('change', render)
  typeSelect.addEventListener('change', runDetection)

  await runDetection()
})()
</script>

</body>
</html>
