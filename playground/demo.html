<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BF-F SDK Demo</title>

  <!-- Fake ad script bait -->
  <script async
    src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
    onerror="window.adBlockerEnabled = true;">
  </script>

  <style>
    body {
      font-family: monospace;
      background: #0e0e0e;
      color: #ddd;
      padding: 20px;
    }

    .ok { color: #00ff9c; }
    .warn { color: #ffd166; }
    .bad { color: #ff5f5f; }

    .panel {
      margin-top: 16px;
      padding: 10px;
      border: 1px dashed #333;
    }

    .signal {
      padding: 6px;
      margin: 6px 0;
      border-left: 3px solid #333;
    }

    .low { background: rgba(255,255,255,0.05); }
    .mid { background: rgba(255,200,0,0.15); }
    .high { background: rgba(255,80,80,0.25); }

    input[type="range"] {
      width: 140px;
    }
  </style>
</head>
<body>

<h1>BF-F SDK Demo</h1>

<div class="panel">
  <strong>Policy thresholds</strong><br />
  Block: <span id="blockT">-</span><br />
  Challenge: <span id="challengeT">-</span><br />
  Monitor: <span id="monitorT">-</span>

  <label>
    Detection type:
    <select id="type">
      <option value="bot" selected>bot</option>
      <option value="adblock">adblock</option>
    </select>
  </label>
</div>

<div class="panel">
  <label>
    Policy preset:
    <select id="preset">
      <option value="conservative">Conservative</option>
      <option value="balanced" selected>Balanced</option>
      <option value="aggressive">Aggressive</option>
    </select>
  </label>

  <br /><br />

  <label>
    Base risk threshold:
    <input
      id="threshold"
      type="range"
      min="0"
      max="1"
      step="0.01"
      value="0.6"
    />
    <span id="thresholdValue">0.60</span>
  </label>
</div>

<pre id="output">Loadingâ€¦</pre>

<script src="../dist/browser.global.js"></script>
<script>
(async function () {
  const engine = BFF.create()

  const typeSelect = document.getElementById('type')
  const presetSelect = document.getElementById('preset')
  const thresholdInput = document.getElementById('threshold')
  const thresholdValue = document.getElementById('thresholdValue')
  const output = document.getElementById('output')

  const blockT = document.getElementById('blockT')
  const challengeT = document.getElementById('challengeT')
  const monitorT = document.getElementById('monitorT')

  const POLICY_PROFILES = {
    conservative: {
      monitor: 0.8
    },
    balanced: {
      block: 1.0,
      challenge: 0.6,
      monitor: 0.3
    },
    aggressive: {
      block: 0.7,
      challenge: 0.4
    }
  }

  let result = null
  let strategyState = {}

  function buildPolicy(base, preset) {
    const policy = new BFF.PolicyEngine()
    const profile = POLICY_PROFILES[preset]

    for (const action in profile) {
      policy.use(
        BFF.confidenceRule(
          base * profile[action],
          action
        )
      )
    }

    return policy
  }

  function renderPolicyThresholds(base, preset) {
    const profile = POLICY_PROFILES[preset]

    blockT.textContent =
      profile.block != null ? (base * profile.block).toFixed(2) : '-'

    challengeT.textContent =
      profile.challenge != null ? (base * profile.challenge).toFixed(2) : '-'

    monitorT.textContent =
      profile.monitor != null ? (base * profile.monitor).toFixed(2) : '-'
  }

  async function runDetection() {
    result = await engine.detect(typeSelect.value)

    strategyState = {}
    for (const s of result.signals) {
      strategyState[s.strategy] = {
        enabled: true,
        weight: s.weight ?? 1
      }
    }

    render()
  }

  function render() {
    if (!result) return

    const threshold = Number(thresholdInput.value)
    const preset = presetSelect.value

    renderPolicyThresholds(threshold, preset)

    const policy = buildPolicy(threshold, preset)

    let suspicion = 0
    for (const s of result.signals) {
      const state = strategyState[s.strategy]
      if (!state.enabled) continue
      suspicion += state.weight * (s.confidence ?? 0)
    }

    const normalized = Math.min(1, suspicion)
    const decision = policy.evaluate({
      ...result,
      suspicion,
      confidence: normalized
    })

    let cls = 'ok'
    if (decision.action === 'challenge') cls = 'warn'
    if (decision.action === 'block') cls = 'bad'

    let text = ''
    text += `${typeSelect.value.toUpperCase()} DETECTION\n`
    text += `Suspicion: ${suspicion.toFixed(2)}\n`
    text += `Confidence: ${normalized.toFixed(2)}\n`
    text += `Decision: ${decision.action.toUpperCase()}\n\n`
    text += `Signals:\n`

    for (const s of result.signals) {
      const state = strategyState[s.strategy]
      const contribution =
        state.enabled ? state.weight * (s.confidence ?? 0) : 0

      let level = 'low'
      if (contribution > 0.5) level = 'mid'
      if (contribution > 1.2) level = 'high'

      text += `- [${state.enabled ? 'x' : ' '}] ${s.strategy}\n`
      text += `  confidence: ${s.confidence ?? 0}\n`
      text += `  weight: ${state.weight}\n`
      text += `  contribution: ${contribution.toFixed(2)} [${level}]\n\n`
    }

    output.textContent = text
    output.className = cls
  }

  output.addEventListener('click', e => {
    const match = e.target.textContent.match(/\[(x| )\] (.+)/)
    if (!match) return
    const id = match[2]
    strategyState[id].enabled = !strategyState[id].enabled
    render()
  })

  thresholdInput.addEventListener('input', () => {
    thresholdValue.textContent = Number(thresholdInput.value).toFixed(2)
    render()
  })

  presetSelect.addEventListener('change', render)
  typeSelect.addEventListener('change', runDetection)

  await runDetection()
})()
</script>

</body>
</html>
